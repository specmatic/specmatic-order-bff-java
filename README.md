# Specmatic Sample: Spring Boot BFF calling Domain API

Table of Contents
<!-- TOC -->
* [Specmatic Sample: Spring Boot BFF calling Domain API](#specmatic-sample-spring-boot-bff-calling-domain-api)
  * [Background](#background)
  * [Tech](#tech)
  * [Run Contract Tests](#run-contract-tests)
    * [1. Using Specmatic-JUnit Helper](#1-using-specmatic-junit-helper)
      * [View Specmatic Test Reports](#view-specmatic-test-reports)
    * [2. Using TestContainers](#2-using-testcontainers)
    * [3. Using Docker](#3-using-docker)
  * [For More Info](#for-more-info)
<!-- TOC -->

## Background
In this sample project, we will use [Specmatic](https://specmatic.io) to contract test the BFF (Backend for Frontend) in isolation. BFF is dependent on Domain API and Kafka. Using this sample project we'll demonstrate both OpenAPI and AsyncAPI support in Specmatic.

Following are the specifications used in this project:

* [BFF's OpenAPI spec](https://github.com/specmatic/specmatic-order-contracts/blob/main/io/specmatic/examples/store/openapi/product_search_bff_v4.yaml) is used for running contract tests against the BFF.
* [Domain API's OpenAPI spec](https://github.com/specmatic/specmatic-order-contracts/blob/main/io/specmatic/examples/store/openapi/api_order_v3.yaml) is used for stubbing the Domain API.
* [AsyncAPI spec](https://github.com/specmatic/specmatic-order-contracts/blob/main/io/specmatic/examples/store/asyncapi/kafka.yaml) of Kafka that defines the topics and message schema and is used for mocking interactions with Kafka.

![HTML client talks to BFF API which in-turn talks to backend API](assets/specmatic-order-bff-architecture.gif)

## Tech
1. Spring boot service in Kotlin
2. Specmatic
3. Specmatic-Kafka
4. Docker Desktop (to run contract test and mock servers using test containers)
5. [Json Query Language](https://jqlang.org/download/) for specmatic-stub hook script

## Run Contract Tests

Our contract test will start the Specmatic stub server for Domain API and Kafka mock using [specmatic config](src/test/resources/specmatic.yaml) and run contract tests against the BFF using Specmatic.

### 1. Using Specmatic-JUnit Helper

For **Unix based systems** and **Windows Powershell**:
```shell
./gradlew test --tests="com.component.orders.contract.ContractTests"
```
#### View Specmatic Test Reports
After running the contract tests, you can view the test reports generated by Specmatic in the following location: [build/reports/specmatic/html/index.html](build/reports/specmatic/html/index.html)

For **Windows Command Prompt**:
```shell
gradlew test --tests="com.component.orders.contract.ContractTests"
```

### 2. Using TestContainers

For **Unix based systems** and **Windows Powershell**:
```shell
./gradlew test --tests="com.component.orders.contract.ContractTestsUsingTestContainer"
```

For **Windows Command Prompt**:
```shell
gradlew test --tests="com.component.orders.contract.ContractTestsUsingTestContainer"
```

### 3. Using Docker

For **Unix based systems** and **Windows Powershell**, execute the following commands in separate terminals:
```shell
# Start the backend service
./gradlew bootRun
```
```shell
# Start the domain api mock server
docker run --rm -p 8090:9000 -v "$(pwd)/src/test/resources/specmatic.yaml:/usr/src/app/specmatic.yaml" -v "$(pwd)/src/test/resources/domain_service:/usr/src/app/domain_service" specmatic/specmatic virtualize --examples /usr/src/app/domain_service
```
```shell
# Start the kafka mock server
docker run --rm -p 9092:9092 -p 2181:2181 -v "$(pwd)/src/test/resources/specmatic.yaml:/usr/src/app/specmatic.yaml" specmatic/specmatic-kafka virtualize
```
```shell
# Run contract tests
docker run --rm --network host -v "$(pwd)/src/test/resources/specmatic.yaml:/usr/src/app/specmatic.yaml" -v "$(pwd)/src/test/resources/bff:/usr/src/app/bff" -v "$(pwd)/build/reports/specmatic:/usr/src/app/build/reports/specmatic" specmatic/specmatic test --port=8080 --examples /usr/src/app/bff
```

For **Windows Command Prompt**, execute the following commands in separate terminals:
```shell
# Start the backend service
gradlew bootRun
```
```shell
# Start the domain api mock server
docker run --rm -p 8090:9000 -v "%cd%/src/test/resources/specmatic.yaml:/usr/src/app/specmatic.yaml" -v "%cd%/src/test/resources/domain_service:/usr/src/app/domain_service" specmatic/specmatic virtualize --examples /usr/src/app/domain_service
```
```shell
# Start the kafka mock server
docker run --rm -p 9092:9092 -p 2181:2181 -v "%cd%/src/test/resources/specmatic.yaml:/usr/src/app/specmatic.yaml" specmatic/specmatic-kafka virtualize
```
```shell
# Run contract tests
docker run --rm --network host -v "%cd%/src/test/resources/specmatic.yaml:/usr/src/app/specmatic.yaml" -v "%cd%/src/test/resources/bff:/usr/src/app/bff" -v "%cd%/build/reports/specmatic:/usr/src/app/build/reports/specmatic" specmatic/specmatic test --port=8080 --examples /usr/src/app/bff
```

## For More Info
* [Specmatic Website](https://specmatic.io)
* [Specmatic Documentation](https://docs.specmatic.io)